import osfrom datetime import datetimefrom io import BytesIOfrom aiogram import Router, Ffrom aiogram.filters import Command, Filterfrom aiogram.fsm.context import FSMContextfrom aiogram.fsm.state import StatesGroup, Statefrom aiogram.types import (    Message,    CallbackQuery,    InlineKeyboardButton,    InlineKeyboardMarkup,    FSInputFile,)from openpyxl import Workbookfrom app.database.sqlite_db import (    get_all_waiters,    get_waiter_by_tg,    add_shift,    set_shift_hours,    set_shift_tasks,    get_all_shifts,    get_shifts_for,)from app.utils.calendar import make_calendaradmin = Router()# --- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ —Ñ–∏–ª—å—Ç—Ä ---ADMIN_IDS = [2015462319, 1773695867]def is_admin(user_id: int) -> bool:    return user_id in ADMIN_IDSclass AdminProtect(Filter):    async def __call__(self, message: Message) -> bool:        return is_admin(message.from_user.id)# --- –°–æ—Å—Ç–æ—è–Ω–∏—è ---class AdminStates(StatesGroup):    ChooseGlobalDate = State()    InputGlobalHours = State()    ChooseWaiter = State()    ChoosePersonalDate = State()    ChooseTaskAction = State()    InputPersonalTasks = State()# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---@admin.message(Command("admin_menu"), AdminProtect())async def cmd_admin_menu(message: Message, state: FSMContext):    await state.clear()    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="üïí –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Å—ã –≤—Å–µ–º", callback_data="AM_SET_HOURS")],        [InlineKeyboardButton(text="üóì –ò–∑–º–µ–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫", callback_data="AM_EDIT_SCHEDULE")],        [InlineKeyboardButton(text="üí∞ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É", callback_data="AM_CALC_SALARY")],        [InlineKeyboardButton(text="üì¢ –ò–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å", callback_data="AM_NOTIFY")],        [InlineKeyboardButton(text="üì• –°–∫–∞—á–∞—Ç—å Excel", callback_data="AM_EXPORT")],    ])    await message.answer("<b>–ú–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>", parse_mode="HTML", reply_markup=kb)# --- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Å—ã –≤—Å–µ–º ---@admin.callback_query(AdminProtect(), F.data == "AM_SET_HOURS")async def start_global_hours(query: CallbackQuery, state: FSMContext):    await state.clear()    year, month = datetime.today().year, datetime.today().month    cal = make_calendar(year, month, set())    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")    ])    await state.set_state(AdminStates.ChooseGlobalDate)    await query.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Å–æ–≤:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_PREV|"), F.state == AdminStates.ChooseGlobalDate)async def prev_global_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) - 1    if m == 0:        y -= 1; m = 12    cal = make_calendar(y, m, set())    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")    ])    await query.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Å–æ–≤:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_NEXT|"), F.state == AdminStates.ChooseGlobalDate)async def next_global_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) + 1    if m == 13:        y += 1; m = 1    cal = make_calendar(y, m, set())    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")    ])    await query.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–∞—Å–æ–≤:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_DAY|"), F.state == AdminStates.ChooseGlobalDate)async def pick_global_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    await state.update_data(global_date=date_str)    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")],    ])    await state.set_state(AdminStates.InputGlobalHours)    await query.message.edit_text(f"–î–∞—Ç–∞: {date_str}\n–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤:", reply_markup=kb)@admin.message(AdminStates.InputGlobalHours, AdminProtect())async def input_global_hours(message: Message, state: FSMContext):    text = message.text.replace(",", ".").strip()    try:        hours = float(text)    except ValueError:        return await message.reply("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")    data = await state.get_data()    date_str = data.get("global_date")    # –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –≤—Å–µ–º –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º    for tg in get_all_waiters():        add_shift(tg, date_str)        set_shift_hours(tg, date_str, hours)    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")],    ])    await message.answer(f"–ì–ª–æ–±–∞–ª—å–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ {hours}—á –Ω–∞ {date_str} –≤—Å–µ–º –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞–º.", reply_markup=kb)    await state.clear()# --- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π ---@admin.callback_query(AdminProtect(), F.data == "AM_EDIT_SCHEDULE")async def start_edit_schedule(query: CallbackQuery, state: FSMContext):    await state.clear()    # —Å–ø–∏—Å–æ–∫ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤ —Å –∏–º–µ–Ω–∞–º–∏    waiters = []    for tg in get_all_waiters():        w = get_waiter_by_tg(tg)        if w:            _, name = w            waiters.append((tg, name or str(tg)))    buttons = [InlineKeyboardButton(text=name, callback_data=f"AM_SELECT_W|{tg}") for tg, name in waiters]    kb = InlineKeyboardMarkup(inline_keyboard=[        *[[b] for b in buttons],        [InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="AM_BACK_MENU")]    ])    await state.set_state(AdminStates.ChooseWaiter)    await query.message.edit_text("–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞:", reply_markup=kb)@admin.callback_query(AdminProtect(), F.data.startswith("AM_SELECT_W|"), F.state == AdminStates.ChooseWaiter)async def select_waiter(query: CallbackQuery, state: FSMContext):    _, tg = query.data.split("|", 1)    tg = int(tg)    await state.update_data(selected_tg=tg)    # —Ä–∏—Å—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è —ç—Ç–æ–≥–æ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞    shifts = get_shifts_for(tg)    year, month = datetime.today().year, datetime.today().month    cal = make_calendar(year, month, set(shifts.keys()))    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É", callback_data="AM_EDIT_SCHEDULE")    ])    await state.set_state(AdminStates.ChoosePersonalDate)    await query.message.edit_text(f"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {tg}:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_PREV|"), F.state == AdminStates.ChoosePersonalDate)async def prev_personal_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    tg = data.get("selected_tg")    _, y, m = query.data.split("|")    y, m = int(y), int(m) - 1    if m == 0:        y -= 1; m = 12    shifts = get_shifts_for(tg)    cal = make_calendar(y, m, set(shifts.keys()))    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É", callback_data="AM_EDIT_SCHEDULE")    ])    await query.message.edit_text(f"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {tg}:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_NEXT|"), F.state == AdminStates.ChoosePersonalDate)async def next_personal_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    tg = data.get("selected_tg")    _, y, m = query.data.split("|")    y, m = int(y), int(m) + 1    if m == 13:        y += 1; m = 1    shifts = get_shifts_for(tg)    cal = make_calendar(y, m, set(shifts.keys()))    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É", callback_data="AM_EDIT_SCHEDULE")    ])    await query.message.edit_text(f"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {tg}:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data.startswith("CAL_DAY|"), F.state == AdminStates.ChoosePersonalDate)async def pick_personal_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    data = await state.get_data()    tg = data.get("selected_tg")    await state.update_data(personal_date=date_str)    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="üìù –ü—Ä–æ–ø–∏—Å–∞—Ç—å –∑–∞–¥–∞—á–∏", callback_data="AM_ENTER_TASKS")],        [InlineKeyboardButton(text="‚ùå –ë–µ–∑ –∑–∞–¥–∞—á", callback_data="AM_RETURN_CALENDAR")],    ])    await state.set_state(AdminStates.ChooseTaskAction)    await query.message.edit_text(f"{date_str}, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ {tg}:", reply_markup=kb)@admin.callback_query(AdminProtect(), F.data == "AM_RETURN_CALENDAR", F.state == AdminStates.ChooseTaskAction)async def return_personal_calendar(query: CallbackQuery, state: FSMContext):    # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã    data = await state.get_data()    tg = data.get("selected_tg")    shifts = get_shifts_for(tg)    year, month = datetime.today().year, datetime.today().month    cal = make_calendar(year, month, set(shifts.keys()))    cal.inline_keyboard.append([        InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É", callback_data="AM_EDIT_SCHEDULE")    ])    await state.set_state(AdminStates.ChoosePersonalDate)    await query.message.edit_text(f"–ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ {tg}:", reply_markup=cal)@admin.callback_query(AdminProtect(), F.data == "AM_ENTER_TASKS", F.state == AdminStates.ChooseTaskAction)async def enter_personal_tasks(query: CallbackQuery, state: FSMContext):    await state.set_state(AdminStates.InputPersonalTasks)    await query.message.edit_text("–í–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –¥–ª—è —Å–º–µ–Ω—ã:")@admin.message(AdminStates.InputPersonalTasks, AdminProtect())async def input_personal_tasks(message: Message, state: FSMContext):    data = await state.get_data()    tg = data.get("selected_tg")    date_str = data.get("personal_date")    tasks = message.text.strip()    add_shift(tg, date_str)    set_shift_tasks(tg, date_str, tasks)    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="‚è™ –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É", callback_data="AM_EDIT_SCHEDULE")]    ])    await message.answer("–ó–∞–¥–∞—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.", reply_markup=kb)    await state.clear()# --- –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é ---@admin.callback_query(AdminProtect(), F.data == "AM_BACK_MENU")async def back_to_menu(query: CallbackQuery, state: FSMContext):    await cmd_admin_menu(query.message, state)# --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---@admin.callback_query(AdminProtect(), F.data == "AM_CALC_SALARY")async def calc_salary(query: CallbackQuery):    rate = float(os.getenv("HOURLY_RATE", "0"))    rows = get_all_shifts()    text = "<b>–†–∞—Å—á—ë—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã</b>\n"    total = 0    for name, date, hrs, _ in rows:        pay = hrs * rate        total += pay        text += f"{name} {date}: {hrs}—á √ó {rate} = {pay:.2f}\n"    text += f"\n<b>–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—Ç–∏—Ç—å: {total:.2f}</b>"    await query.message.edit_text(text, parse_mode="HTML")@admin.callback_query(AdminProtect(), F.data == "AM_NOTIFY")async def notify_waiters(query: CallbackQuery):    # –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏    await query.message.edit_text("–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")@admin.callback_query(AdminProtect(), F.data == "AM_EXPORT")async def export_schedule(query: CallbackQuery):    rows = get_all_shifts()    wb = Workbook()    ws = wb.active    ws.append(["–°–æ—Ç—Ä—É–¥–Ω–∏–∫", "–î–∞—Ç–∞", "–ß–∞—Å—ã", "–ó–∞–¥–∞—á–∏"])    for name, date, hrs, tasks in rows:        ws.append([name, date, hrs, tasks])    buf = BytesIO()    wb.save(buf)    buf.seek(0)    await query.message.edit_document(document=FSInputFile(buf, filename="schedule.xlsx"))