import calendarimport osfrom datetime import datetime, timedeltafrom io import BytesIOfrom typing import Setfrom aiogram import Router, Ffrom aiogram.filters import Command, Filter, StateFilterfrom aiogram.fsm.context import FSMContextfrom aiogram.fsm.state import StatesGroup, Statefrom aiogram.types import (    CallbackQuery,    FSInputFile,    InlineKeyboardButton,    InlineKeyboardMarkup,    Message,)from openpyxl import Workbook# Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â€” Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸-Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ¸from app.database.sqlite_db import (    add_shift,    base,    cur,    get_all_shifts,    get_all_waiters,    get_waiter_by_tg,    set_shift_hours,    set_shift_tasks,)# ==============================================================================#   Router & Admin guard# ==============================================================================admin = Router()ADMIN_IDS = [2015462319, 1773695867]class AdminProtect(Filter):    """ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²."""    async def __call__(self, event) -> bool:  # noqa: D401 â€“ aiogramâ€‘signature        user = getattr(event, "from_user", None)        return bool(user and user.id in ADMIN_IDS)# ==============================================================================#   ĞĞ±Ñ‰Ğ¸Ğµ UIâ€‘ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹# ==============================================================================KB_BACK_MENU = InlineKeyboardMarkup(    inline_keyboard=[[InlineKeyboardButton("âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]])def make_calendar(year: int, month: int, marked: Set[str]) -> InlineKeyboardMarkup:    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ inlineâ€‘ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ Ğ´Ğ»Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°."""    kb: list[list[InlineKeyboardButton]] = []    # â”€â”€ Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    kb.append(        [            InlineKeyboardButton("â€¹", callback_data=f"CAL_PREV|{year}|{month}"),            InlineKeyboardButton(f"{calendar.month_name[month]} {year}", callback_data="IGNORE"),            InlineKeyboardButton("â€º", callback_data=f"CAL_NEXT|{year}|{month}"),        ]    )    # â”€â”€ Ğ”Ğ½Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    kb.append([InlineKeyboardButton(d, callback_data="IGNORE") for d in ["ĞŸĞ½", "Ğ’Ñ‚", "Ğ¡Ñ€", "Ğ§Ñ‚", "ĞŸÑ‚", "Ğ¡Ğ±", "Ğ’Ñ"]])    # â”€â”€ Ğ”Ğ½Ğ¸ Ğ¼ĞµÑÑÑ†Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    for week in calendar.Calendar(firstweekday=0).monthdayscalendar(year, month):        row: list[InlineKeyboardButton] = []        for day in week:            if day == 0:                row.append(InlineKeyboardButton(" ", callback_data="IGNORE"))            else:                ds = f"{year:04d}-{month:02d}-{day:02d}"                mark = "âœ“" if ds in marked else ""                row.append(InlineKeyboardButton(f"{day}{mark}", callback_data=f"CAL_DAY|{ds}"))        kb.append(row)    # â”€â”€ ĞĞ¸Ğ· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    kb.append([InlineKeyboardButton("âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="CAL_CANCEL")])    kb.append([InlineKeyboardButton("ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑÑ†", callback_data="AM_CLEAR_SCHEDULE")])    return InlineKeyboardMarkup(inline_keyboard=kb)# ==============================================================================#   FSMâ€‘ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ# ==============================================================================class EditSchedStates(StatesGroup):    ChooseDate = State()    ChooseWaiter = State()    ChooseTaskAction = State()    InputPersonalTasks = State()class SetHoursStates(StatesGroup):    ChooseWaiter = State()    ChooseDate = State()    InputStartTime = State()    InputEndTime = State()# ==============================================================================#   Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸# ==============================================================================async def _safe_delete_message(bot, chat_id: int, msg_id: int):    """ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ; Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»ÑĞ±Ñ‹Ğµ Telegramâ€‘Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ."""    try:        await bot.delete_message(chat_id, msg_id)    except Exception:        pass# ==============================================================================#   IGNORE â€“ Ğ´Ğ»Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ñ… callback'Ğ¾Ğ²# ==============================================================================@admin.callback_query(F.data == "IGNORE")async def _ignore_callback(query: CallbackQuery):    await query.answer()# ==============================================================================#   Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ# ==============================================================================@admin.message(Command("admin_menu"), AdminProtect())async def admin_menu(message: Message, state: FSMContext):    await state.clear()    kb = InlineKeyboardMarkup(        inline_keyboard=[            [InlineKeyboardButton("ğŸ—“ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº", callback_data="AM_EDIT_SCHEDULE")],            [InlineKeyboardButton("ğŸ•’ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‡Ğ°ÑÑ‹", callback_data="AM_SET_HOURS")],            [InlineKeyboardButton("ğŸ’° Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñƒ", callback_data="AM_CALC_SALARY")],            [InlineKeyboardButton("ğŸ“¢ Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", callback_data="AM_NOTIFY")],            [InlineKeyboardButton("ğŸ“¥ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Excel", callback_data="AM_EXPORT")],        ]    )    await message.answer("<b>ĞœĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</b>", parse_mode="HTML", reply_markup=kb)# ==============================================================================#   Ğ‘Ğ›ĞĞš: Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ Ğ§ĞĞ¡ĞĞ’# ==============================================================================@admin.callback_query(AdminProtect(), F.data == "AM_SET_HOURS")async def sh_start(query: CallbackQuery, state: FSMContext):    await state.clear()    buttons = [        [InlineKeyboardButton(get_waiter_by_tg(tg)[1] or str(tg), callback_data=f"SH_WAITER|{tg}")]        for tg in get_all_waiters()    ]    await state.set_state(SetHoursStates.ChooseWaiter)    await query.message.edit_text(        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ñ‡Ğ°ÑĞ¾Ğ²:",        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons),    )@admin.callback_query(AdminProtect(), StateFilter(SetHoursStates.ChooseWaiter), F.data.startswith("SH_WAITER|"))async def sh_choose_waiter(query: CallbackQuery, state: FSMContext):    _, tg = query.data.split("|", 1)    await state.update_data(selected_tg=int(tg))    today = datetime.today()    kb = make_calendar(today.year, today.month, set())    await state.set_state(SetHoursStates.ChooseDate)    await query.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ ÑĞ¼ĞµĞ½Ñ‹:", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(SetHoursStates.ChooseDate), F.data.startswith("CAL_DAY|"))async def sh_choose_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    await state.update_data(shift_date=date_str)    await state.set_state(SetHoursStates.InputStartTime)    prompt = await query.message.edit_text(f"Ğ”Ğ°Ñ‚Ğ°: {date_str}\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¼ĞµĞ½Ñ‹ (HH:MM):")    await state.update_data(prompt_id=prompt.message_id)@admin.message(AdminProtect(), StateFilter(SetHoursStates.InputStartTime))async def sh_input_start(message: Message, state: FSMContext):    data = await state.get_data()    if pid := data.get("prompt_id"):        await _safe_delete_message(message.bot, message.chat.id, pid)    try:        start_t = datetime.strptime(message.text.strip(), "%H:%M").time()    except ValueError:        await message.reply("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ")        return    await state.update_data(start_time=start_t, user_msg_id=message.message_id)    await state.set_state(SetHoursStates.InputEndTime)    prompt = await message.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ (HH:MM):")    await state.update_data(prompt_id=prompt.message_id)@admin.message(AdminProtect(), StateFilter(SetHoursStates.InputEndTime))async def sh_input_end(message: Message, state: FSMContext):    data = await state.get_data()    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ    for mid in (data.get("prompt_id"), data.get("user_msg_id")):        if mid:            await _safe_delete_message(message.bot, message.chat.id, mid)    try:        end_t = datetime.strptime(message.text.strip(), "%H:%M").time()    except ValueError:        await message.reply("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ")        return    dt_start = datetime.combine(datetime.today(), data["start_time"])    dt_end = datetime.combine(datetime.today(), end_t)    if dt_end < dt_start:        dt_end += timedelta(days=1)    hours = (dt_end - dt_start).total_seconds() / 3600    waiter_id = get_waiter_by_tg(data["selected_tg"])[0]    add_shift(waiter_id, data["shift_date"])    set_shift_hours(waiter_id, data["shift_date"], hours)    await message.answer(        f"Ğ¡Ğ¼ĞµĞ½Ğ° {data['shift_date']}: {hours:.2f} Ñ‡ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°.", reply_markup=KB_BACK_MENU    )    await state.clear()# ==============================================================================#   Ğ‘Ğ›ĞĞš: Ğ Ğ•Ğ”ĞĞšĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ“Ğ ĞĞ¤Ğ˜ĞšĞ# ==============================================================================@admin.callback_query(AdminProtect(), F.data == "AM_EDIT_SCHEDULE")async def es_start(query: CallbackQuery, state: FSMContext):    await state.clear()    today = datetime.today()    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(today.year, today.month, marked)    await state.set_state(EditSchedStates.ChooseDate)    await state.update_data(cal_year=today.year, cal_month=today.month)    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data.startswith("CAL_PREV|"))async def es_prev_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    y, m = data["cal_year"], data["cal_month"] - 1    if m == 0:        y, m = y - 1, 12    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(y, m, marked)    await state.update_data(cal_year=y, cal_month=m)    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data.startswith("CAL_NEXT|"))async def es_next_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    y, m = data["cal_year"], data["cal_month"] + 1    if m == 13:        y, m = y + 1, 1    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(y, m, marked)    await state.update_data(cal_year=y, cal_month=m)    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data == "AM_CLEAR_SCHEDULE")async def es_clear_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    y, m = data["cal_year"], data["cal_month"]    cur.execute("DELETE FROM shifts WHERE date LIKE ?", (f"{y:04d}-{m:02d}-%",))    base.commit()    await query.answer(f"Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ·Ğ° {y}-{m:02d} Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½", show_alert=True)    kb = make_calendar(y, m, set())    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data.startswith("CAL_DAY|"))async def es_choose_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    await state.update_data(edit_date=date_str)    buttons = [        [InlineKeyboardButton(get_waiter_by_tg(tg)[1] or str(tg), callback_data=f"ES_WAITER|{tg}")]        for tg in get_all_waiters()    ]    await state.set_state(EditSchedStates.ChooseWaiter)    await query.message.edit_text(        f"Ğ”Ğ°Ñ‚Ğ°: {date_str}\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°:",        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons),    )@admin.callback_query(AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data == "CAL_CANCEL")async def es_cancel(query: CallbackQuery, state: FSMContext):    await state.clear()    await admin_menu(query.message, state)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€#   ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ½Ñ‚Ğ°# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data.startswith("ES_WAITER|"))async def es_ask_tasks(query: CallbackQuery, state: FSMContext):    _, tg = query.data.split("|", 1)    await state.update_data(selected_tg=int(tg))    date_str = (await state.get_data())["edit_date"]    kb = InlineKeyboardMarkup(        inline_keyboard=[            [InlineKeyboardButton("ğŸ“ ĞŸÑ€Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸", callback_data="ES_TASKS")],            [InlineKeyboardButton("âŒ Ğ‘ĞµĞ· Ğ·Ğ°Ğ´Ğ°Ñ‡", callback_data="ES_NO_TASKS")],        ]    )    await state.set_state(EditSchedStates.ChooseTaskAction)    await query.message.edit_text(        f"{date_str} â€” {(get_waiter_by_tg(int(tg))[1] or tg)}", reply_markup=kb    )@admin.callback_query(AdminProtect(), F.data == "ES_NO_TASKS")async def es_save_no_tasks(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    waiter_id = get_waiter_by_tg(data["selected_tg"])[0]    add_shift(waiter_id, data["edit_date"])    await query.message.edit_text("Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚. Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½.", reply_markup=KB_BACK_MENU)    await state.clear()@admin.callback_query(AdminProtect(), F.data == "ES_TASKS")async def es_ask_personal_tasks(query: CallbackQuery, state: FSMContext):    await state.set_state(EditSchedStates.InputPersonalTasks)    prompt = await query.message.edit_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ ÑĞ¼ĞµĞ½Ñ‹:")    await state.update_data(prompt_id=prompt.message_id)@admin.message(AdminProtect(), StateFilter(EditSchedStates.InputPersonalTasks))async def es_save_tasks(message: Message, state: FSMContext):    data = await state.get_data()    if pid := data.get("prompt_id"):        await _safe_delete_message(message.bot, message.chat.id, pid)    waiter_id = get_waiter_by_tg(data["selected_tg"])[0]    add_shift(waiter_id, data["edit_date"])    set_shift_tasks(waiter_id, data["edit_date"], message.text.strip())    await message.answer("Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹.", reply_markup=KB_BACK_MENU)    await state.clear()# ==============================================================================#   Ğ’ĞĞ—Ğ’Ğ ĞĞ¢ Ğ’ ĞœĞ•ĞĞ® ĞĞ”ĞœĞ˜ĞĞ (ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹)# ==============================================================================@admin.callback_query(AdminProtect(), F.data == "AM_BACK_MENU")async def back_to_menu(query: CallbackQuery, state: FSMContext):    await admin_menu(query.message, state)    # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ²ÑˆĞµĞµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚    await _safe_delete_message(query.bot, query.message.chat.id, query.message.message_id)# ==============================================================================#   Ğ‘Ğ›ĞĞš: Ğ ĞĞ¡Ğ§ĞĞ¢ Ğ—ĞĞ ĞŸĞ›ĞĞ¢Ğ«# ==============================================================================def _make_salary_keyboard(year: int, month: int) -> InlineKeyboardMarkup:    return InlineKeyboardMarkup(        inline_keyboard=[            [InlineKeyboardButton("ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ·Ğ° Ğ¼ĞµÑÑÑ†", callback_data=f"AM_CLEAR_PAY|{year}|{month:02d}")],            [InlineKeyboardButton("âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")],        ]    )@admin.callback_query(AdminProtect(), F.data == "AM_CALC_SALARY")async def calc_salary(query: CallbackQuery):    rate = float(os.getenv("HOURLY_RATE", "0"))    total = 0.0    today = datetime.today()    ym_year, ym_month = today.year, today.month    text = "<b>Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñ‹</b>\n"    for name, date_str, hrs, _ in get_all_shifts():        if hrs is None:            continue        pay = hrs * rate        total += pay        text += f"{name} {date_str}: {hrs:.2f} Ñ‡ Ã— {rate} = {pay:.2f}\n"    text += f"\n<b>Ğ’ÑĞµĞ³Ğ¾ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚ÑŒ: {total:.2f}</b>"    await query.message.edit_text(        text,        parse_mode="HTML",        reply_markup=_make_salary_keyboard(ym_year, ym_month),    )# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€#   ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data.startswith("AM_CLEAR_PAY|"))async def clear_payments(query: CallbackQuery, state: FSMContext):    _, y_str, m_str = query.data.split("|", 2)    cur.execute("UPDATE shifts SET hours=NULL WHERE date LIKE ?", (f"{y_str}-{m_str}-%",))    base.commit()    await query.answer("Ğ§Ğ°ÑÑ‹ Ğ·Ğ° Ğ¼ĞµÑÑÑ† Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ñ‹!", show_alert=True)    await admin_menu(query.message, state)# ==============================================================================#   Ğ‘Ğ›ĞĞš: Ğ˜ĞĞ¤ĞĞ ĞœĞ˜Ğ ĞĞ’ĞĞĞ˜Ğ•# ==============================================================================@admin.callback_query(AdminProtect(), F.data == "AM_NOTIFY")async def notify_staff(query: CallbackQuery):    await query.message.edit_text("ĞĞ¿Ğ¾Ğ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾.", reply_markup=KB_BACK_MENU)# ==============================================================================#   Ğ‘Ğ›ĞĞš: Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢ Ğ’ EXCEL# ==============================================================================@admin.callback_query(AdminProtect(), F.data == "AM_EXPORT")async def export_excel(query: CallbackQuery):    wb = Workbook()    ws = wb.active    ws.append(["Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº", "Ğ”Ğ°Ñ‚Ğ°", "Ğ§Ğ°ÑÑ‹", "Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸"])    for name, date_str, hrs, tasks in get_all_shifts():        ws.append([name, date_str, hrs, tasks])    buf = BytesIO()    wb.save(buf)    buf.seek(0)    await query.message.edit_document(FSInputFile(buf, filename="schedule.xlsx"))# ==============================================================================#   ĞšĞĞĞ•Ğ¦ Ğ¤ĞĞ™Ğ›Ğ# ==============================================================================