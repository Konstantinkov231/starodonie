"""Admin-side handlers for Â«Ğ¡Ñ‚Ğ°Ñ€Ğ¾Ğ´Ğ¾Ğ½ÑŒĞµÂ»-Ğ±Ğ¾Ñ‚Ğ°."""from __future__ import annotationsimport calendarimport osimport tempfilefrom datetime import datetime, timedeltafrom typing import Optional, Set, Tuplefrom aiogram import Router, Ffrom aiogram.filters import Command, Filter, StateFilterfrom aiogram.fsm.context import FSMContextfrom aiogram.fsm.state import StatesGroup, Statefrom aiogram.types import (    CallbackQuery,    InlineKeyboardButton,    InlineKeyboardMarkup,    Message,    FSInputFile)from openpyxl import Workbookfrom openpyxl.styles import Alignment, Font, Border, Sidefrom app.database import sqlite_db# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# DB helpers# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€from app.database.sqlite_db import (    add_shift,    get_all_shifts,    get_employees_with_shifts,  # Added import    get_all_waiters,    get_waiter_by_tg,    set_shift_hours,    set_shift_tasks,    get_all_employees,    get_work_hours,    get_all_work_hours_dates,)cur = Nonedef get_cursor():    """    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ cursor SQLite.    * Ğ•ÑĞ»Ğ¸ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ ĞµÑ‰Ñ‘ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ (sqlite_db.base is None),      Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ sql_start().    * ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ±ĞµÑ€Ñ‘Ñ‚ cursor() Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ â€” Ñ‚Ğ°Ğº Ğ¸Ğ·Ğ±ĞµĞ³Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼      Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼Ğ¸ ĞºÑƒÑ€ÑĞ¾Ñ€Ğ°Ğ¼Ğ¸.    """    if sqlite_db.base is None:        sqlite_db.sql_start()          # Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ” Â«Ğ½Ğ° Ğ»ĞµÑ‚ÑƒÂ»    return sqlite_db.base.cursor()async def _safe_delete_message(bot, chat_id: int, msg_id: Optional[int]):    if msg_id:        try:            await bot.delete_message(chat_id, msg_id)        except Exception:            passdef _format_payline(*args) -> Tuple[str, float]:    """Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°: (date, hrs, rate) Ğ¸Ğ»Ğ¸ (name, date, hrs, rate)."""    if len(args) == 3:        date, hrs, rate = args        if hrs is None:            return f"â€¢ {date}: â€”", 0.0        pay = hrs * rate        return f"â€¢ {date}: {hrs:.2f} Ñ‡ Ã— {rate} = {pay:.2f}", pay    elif len(args) == 4:        name, date, hrs, rate = args        if hrs is None:            return f"{name} {date}: â€”", 0.0        pay = hrs * rate        return f"{name} {date}: {hrs:.2f} Ñ‡ Ã— {rate} = {pay:.2f}", pay    raise TypeError("_format_payline expects 3 or 4 args")# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# Router & guard# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€admin = Router()ADMIN_IDS = [2015462319, 1773695867]def export_hours_schedule(start_date: datetime, employees: list[dict], get_hours_fn, output_path: str):    """    Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Excel-Ñ„Ğ°Ğ¹Ğ» Ñ Ñ‡Ğ°ÑĞ¾Ğ²ĞºĞ¾Ğ¹ Ğ·Ğ° 15 Ğ´Ğ½ĞµĞ¹, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹:    - start_date: Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° (datetime)    - employees: ÑĞ¿Ğ¸ÑĞ¾Ğº ÑĞ»Ğ¾Ğ²Ğ°Ñ€ĞµĞ¹ Ñ ĞºĞ»ÑÑ‡Ğ°Ğ¼Ğ¸ 'last_name', 'first_name', 'role', 'id'    - get_hours_fn(id, date_str) -> float (Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‡Ğ°ÑÑ‹ Ğ´Ğ»Ñ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ½Ğ° Ğ´Ğ°Ñ‚Ñƒ 'YYYY-MM-DD')    """    # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ĞºĞ½Ğ¸Ğ³Ğ¸ Ğ¸ Ğ»Ğ¸ÑÑ‚Ğ°    wb = Workbook()    ws = wb.active    ws.title = f"Ğ§Ğ°ÑĞ¾Ğ²ĞºĞ° {start_date.strftime('%d%m%Y')}"    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ 15-Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ğ¹ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½    date_range = [start_date + timedelta(days=i) for i in range(15)]    # Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ° ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ¾Ğ²    col_widths = [15, 15] + [5] * (len(date_range) + 1)  # Ğ¤Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ, Ğ˜Ğ¼Ñ, 15 Ğ´Ğ½ĞµĞ¹, Ğ˜Ñ‚Ğ¾Ğ³Ğ¾    for i, w in enumerate(col_widths, start=1):        ws.column_dimensions[ws.cell(row=1, column=i).column_letter].width = w    # Ğ¡Ñ‚Ğ¸Ğ»Ğ¸    bold = Font(bold=True)    center = Alignment(horizontal="center", vertical="center")    thin_border = Border(        left=Side(style='thin'), right=Side(style='thin'),        top=Side(style='thin'), bottom=Side(style='thin')    )    # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº    headers = ["Ğ¤Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ", "Ğ˜Ğ¼Ñ"]    headers += [d.strftime("%d.%m") for d in date_range]  # Ğ”Ğ°Ñ‚Ñ‹ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ DD.MM    headers.append("Ğ˜Ñ‚Ğ¾Ğ³Ğ¾")    ws.append(headers)    for col in range(1, len(headers) + 1):        cell = ws.cell(row=1, column=col)        cell.font = bold        cell.alignment = center        cell.border = thin_border    # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ñ€Ğ¾Ğ»ÑĞ¼    roles = sorted(set(emp['role'] for emp in employees))    row_idx = 2    for role in roles:        # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº ÑĞµĞºÑ†Ğ¸Ğ¸: Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ²ÑĞµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸        ws.merge_cells(start_row=row_idx, start_column=1, end_row=row_idx, end_column=len(headers))        cell = ws.cell(row=row_idx, column=1)        cell.value = role        cell.font = Font(bold=True, size=12)        cell.alignment = center        row_idx += 1        # Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ€Ğ¾Ğ»Ğ¸        for emp in [e for e in employees if e['role'] == role]:            row_values = [emp['last_name'], emp['first_name']]            # Ğ§Ğ°ÑÑ‹ Ğ·Ğ° 15 Ğ´Ğ½ĞµĞ¹            for d in date_range:                date_str = d.strftime("%Y-%m-%d")                hrs = get_hours_fn(emp['id'], date_str) or 0                row_values.append(hrs)            # Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ° Ğ¸Ñ‚Ğ¾Ğ³            col_start = 3            col_end = 3 + len(date_range) - 1            row_values.append(f"=SUM(C{row_idx}:" + ws.cell(row=row_idx, column=col_end).column_letter + f"{row_idx})")            # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ            for col, val in enumerate(row_values, start=1):                cell = ws.cell(row=row_idx, column=col)                cell.value = val                cell.alignment = center                cell.border = thin_border            row_idx += 1    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»    wb.save(output_path)class AdminProtect(Filter):    async def __call__(self, event) -> bool:        user = getattr(event, "from_user", None)        return bool(user and user.id in ADMIN_IDS)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# FSM Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€class AddEmployeeStates(StatesGroup):    ChooseRole     = State()    InputLastName  = State()    InputFirstName = State()    InputRate      = State()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# FSM Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°ÑĞ¾Ğ²# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€class EditHoursStates(StatesGroup):    ChooseEmployee = State()    ChooseDate     = State()    InputStartTime = State()    InputEndTime   = State()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# FSM Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€class ExportScheduleStates(StatesGroup):    ChooseStartDate = State()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# UI helpers# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€KB_BACK_MENU = InlineKeyboardMarkup(    inline_keyboard=[[InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]])def make_calendar(year: int, month: int, marked: Set[str]) -> InlineKeyboardMarkup:    kb: list[list[InlineKeyboardButton]] = []    kb.append([        InlineKeyboardButton(text="â€¹", callback_data=f"CAL_PREV|{year}|{month}"),        InlineKeyboardButton(text=f"{calendar.month_name[month]} {year}", callback_data="IGNORE"),        InlineKeyboardButton(text="â€º", callback_data=f"CAL_NEXT|{year}|{month}"),    ])    kb.append([        InlineKeyboardButton(text=d, callback_data="IGNORE")        for d in ["ĞŸĞ½","Ğ’Ñ‚","Ğ¡Ñ€","Ğ§Ñ‚","ĞŸÑ‚","Ğ¡Ğ±","Ğ’Ñ"]    ])    for week in calendar.Calendar(firstweekday=0).monthdayscalendar(year, month):        row = []        for day in week:            if day == 0:                row.append(InlineKeyboardButton(text=" ", callback_data="IGNORE"))            else:                ds = f"{year:04d}-{month:02d}-{day:02d}"                mark = "âœ“" if ds in marked else ""                row.append(InlineKeyboardButton(text=f"{day}{mark}", callback_data=f"CAL_DAY|{ds}"))        kb.append(row)    kb.append([InlineKeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="CAL_CANCEL")])    kb.append([InlineKeyboardButton(text="ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑÑ†", callback_data="AM_CLEAR_SCHEDULE")])    return InlineKeyboardMarkup(inline_keyboard=kb)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# FSM states# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€class EditSchedStates(StatesGroup):    ChooseDate = State()    ChooseWaiter = State()    ChooseTaskAction = State()    InputPersonalTasks = State()class SetHoursStates(StatesGroup):    ChooseWaiter = State()    ChooseDate = State()    InputStartTime = State()    InputEndTime = State()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# IGNORE# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(F.data == "IGNORE")async def _ignore(query: CallbackQuery): await query.answer()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# MAIN MENU# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.message(Command("admin_menu"), AdminProtect())async def admin_menu(message: Message, state: FSMContext):    await state.clear()    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="ğŸ—“ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº (ÑĞ¼ĞµĞ½Ñ‹)", callback_data="AM_EDIT_SCHEDULE")],        [InlineKeyboardButton(text="ğŸ•’ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‡Ğ°ÑĞ¾Ğ²ĞºÑƒ", callback_data="AM_EDIT_HOURS")],        [InlineKeyboardButton(text="â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°", callback_data="AM_ADD_EMPLOYEE")],        [InlineKeyboardButton(text="ğŸ’° Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñƒ", callback_data="AM_CALC_SALARY")],        [InlineKeyboardButton(text="ğŸ“¥ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ", callback_data="AM_EXPORT_ALL")],    ])    await message.answer("<b>ĞœĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</b>", parse_mode="HTML", reply_markup=kb)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# ADD EMPLOYEE# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_ADD_EMPLOYEE")async def add_employee_start(query: CallbackQuery, state: FSMContext):    await state.clear()    await state.set_state(AddEmployeeStates.ChooseRole)    await query.message.edit_text(        "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ€Ğ¾Ğ»ÑŒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, ĞĞ¤Ğ˜Ğ¦Ğ˜ĞĞĞ¢Ğ«, ĞŸĞĞœĞĞ©ĞĞ˜ĞšĞ˜):"    )@admin.message(AdminProtect(), StateFilter(AddEmployeeStates.ChooseRole))async def add_employee_role(message: Message, state: FSMContext):    role = message.text.strip()    await state.update_data(role=role)    await state.set_state(AddEmployeeStates.InputLastName)    await message.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ„Ğ°Ğ¼Ğ¸Ğ»Ğ¸Ñ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°:")@admin.message(AdminProtect(), StateFilter(AddEmployeeStates.InputLastName))async def add_employee_last_name(message: Message, state: FSMContext):    last_name = message.text.strip()    await state.update_data(last_name=last_name)    await state.set_state(AddEmployeeStates.InputFirstName)    await message.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°:")@admin.message(AdminProtect(), StateFilter(AddEmployeeStates.InputFirstName))async def add_employee_first_name(message: Message, state: FSMContext):    first_name = message.text.strip()    await state.update_data(first_name=first_name)    await state.set_state(AddEmployeeStates.InputRate)    await message.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ğ²ĞºÑƒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° (Ñ€ÑƒĞ±/Ñ‡Ğ°Ñ, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 140):")@admin.message(AdminProtect(), StateFilter(AddEmployeeStates.InputRate))async def add_employee_rate(message: Message, state: FSMContext):    data = await state.get_data()    try:        rate = float(message.text.strip())        if rate <= 0:            raise ValueError("Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ¼")    except ValueError:        await message.answer("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 140).")        return    role = data["role"]    last_name = data["last_name"]    first_name = data["first_name"]    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ² Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºÑƒ    sqlite_db.add_employee(last_name, first_name, role, rate)    await message.answer(        f"Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº {last_name} {first_name} ({role}) Ñ ÑÑ‚Ğ°Ğ²ĞºĞ¾Ğ¹ {rate} Ñ€ÑƒĞ±/Ñ‡Ğ°Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½.",        reply_markup=KB_BACK_MENU    )    await state.clear()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# SET HOURS block (complete)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_EDIT_HOURS")async def sh_start(query: CallbackQuery, state: FSMContext):    await state.clear()    await state.set_state(SetHoursStates.ChooseWaiter)    # Fetch employees linked to waiters or standalone waiters    employees_shifts = get_employees_with_shifts()    if not employees_shifts:        await query.message.edit_text(            "ĞĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°ÑĞ¾Ğ².",            reply_markup=InlineKeyboardMarkup(inline_keyboard=[                [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]            ])        )        return    # Create a list of unique waiters by waiter_id    seen = set()    unique_waiters = [        (waiter_id, name)        for waiter_id, name, _, _, _ in employees_shifts        if not (waiter_id in seen or seen.add(waiter_id))    ]    if not unique_waiters:        await query.message.edit_text(            "ĞĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‡Ğ°ÑĞ¾Ğ².",            reply_markup=InlineKeyboardMarkup(inline_keyboard=[                [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]            ])        )        return    buttons = [        [InlineKeyboardButton(text=f"{name}", callback_data=f"EH_EMP|{waiter_id}")]        for waiter_id, name in unique_waiters    ]    buttons.append([InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")])    await query.message.edit_text(        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Ñ‡Ğ°ÑĞ¾Ğ²:",        reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons),    )@admin.callback_query(AdminProtect(), StateFilter(SetHoursStates.ChooseWaiter), F.data.startswith("EH_EMP|"))async def sh_choose_waiter(query: CallbackQuery, state: FSMContext):    _, waiter_id = query.data.split("|", 1)    waiter_id = int(waiter_id)    await state.update_data(waiter_id=waiter_id)  # Store waiter_id instead of emp_id    today = datetime.today()    marked = set(get_all_work_hours_dates())    kb = make_calendar(today.year, today.month, marked)    await state.set_state(SetHoursStates.ChooseDate)    await query.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ ÑĞ¼ĞµĞ½Ñ‹:", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(SetHoursStates.ChooseDate), F.data.startswith("CAL_DAY|"))async def sh_choose_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    await state.update_data(shift_date=date_str)    await state.set_state(SetHoursStates.InputStartTime)    m = await query.message.edit_text(f"Ğ”Ğ°Ñ‚Ğ°: {date_str}\nĞ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¼ĞµĞ½Ñ‹ (HH:MM):")    await state.update_data(prompt_id=m.message_id)@admin.message(AdminProtect(), StateFilter(SetHoursStates.InputStartTime))async def sh_input_start(message: Message, state: FSMContext):    data = await state.get_data()    await _safe_delete_message(message.bot, message.chat.id, data.get("prompt_id"))    try:        start_t = datetime.strptime(message.text.strip(), "%H:%M").time()    except ValueError:        await message.reply("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ")        return    await state.update_data(start_time=start_t, user_msg_id=message.message_id)    await state.set_state(SetHoursStates.InputEndTime)    m = await message.answer("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ ÑĞ¼ĞµĞ½Ñ‹ (HH:MM):")    await state.update_data(prompt_id=m.message_id)@admin.message(AdminProtect(), StateFilter(SetHoursStates.InputEndTime))async def sh_input_end(message: Message, state: FSMContext):    data = await state.get_data()    for mid in (data.get("prompt_id"), data.get("user_msg_id")):        await _safe_delete_message(message.bot, message.chat.id, mid)    try:        end_t = datetime.strptime(message.text.strip(), "%H:%M").time()    except ValueError:        await message.reply("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ")        return    dt0 = datetime.combine(datetime.today(), data["start_time"])    dt1 = datetime.combine(datetime.today(), end_t)    if dt1 < dt0:        dt1 += timedelta(days=1)    hrs = (dt1 - dt0).total_seconds() / 3600    waiter_id = data["waiter_id"]  # Use waiter_id    add_shift(waiter_id, data["shift_date"])    set_shift_hours(waiter_id, data["shift_date"], hrs)    await message.answer(        f"Ğ¡Ğ¼ĞµĞ½Ğ° {data['shift_date']}: {hrs:.2f} Ñ‡ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°.", reply_markup=KB_BACK_MENU    )    await state.clear()# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# EDIT SCHEDULE block (complete)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_EDIT_SCHEDULE")async def es_start(query: CallbackQuery, state: FSMContext):    """Ğ¡Ñ‚Ğ°Ñ€Ñ‚: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¼ĞµÑÑÑ†Ğ° Ñ Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ¼ĞµĞ½Ğ°Ğ¼Ğ¸."""    today = datetime.today()    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(today.year, today.month, marked)    kb.inline_keyboard.append(        [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]    )    await state.set_state(EditSchedStates.ChooseDate)    await state.update_data(edit_year=today.year, edit_month=today.month)    await query.message.edit_text(        "Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ",        reply_markup=kb,    )# â”€â”€â”€â”€â”€ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¼ĞµÑÑÑ†Ğ°Ğ¼ â”€â”€â”€â”€â”€@admin.callback_query(    AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data.startswith("CAL_PREV|"))async def es_prev_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) - 1    if m == 0:        y, m = y - 1, 12    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(y, m, marked)    kb.inline_keyboard.append(        [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]    )    await state.update_data(edit_year=y, edit_month=m)    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)@admin.callback_query(    AdminProtect(), StateFilter(EditSchedStates.ChooseDate), F.data.startswith("CAL_NEXT|"))async def es_next_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) + 1    if m == 13:        y, m = y + 1, 1    marked = {row[1] for row in get_all_shifts()}    kb = make_calendar(y, m, marked)    kb.inline_keyboard.append(        [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]    )    await state.update_data(edit_year=y, edit_month=m)    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)# â”€â”€â”€â”€â”€ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑÑ† â”€â”€â”€â”€â”€@admin.callback_query(    AdminProtect(),    StateFilter(EditSchedStates.ChooseDate),    F.data == "AM_CLEAR_SCHEDULE",)async def es_clear_month(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    y, m = data["edit_year"], data["edit_month"]    cur = get_cursor()    cur.execute("DELETE FROM shifts WHERE date LIKE ?", (f"{y:04d}-{m:02d}-%",))    sqlite_db.base.commit()    await query.answer(f"Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ·Ğ° {y}-{m:02d} Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½", show_alert=True)    kb = make_calendar(y, m, set())    kb.inline_keyboard.append(        [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")]    )    await query.message.edit_text("Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº: Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ", reply_markup=kb)# â”€â”€â”€â”€â”€ Ğ´Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° â”€â”€â”€â”€â”€@admin.callback_query(    AdminProtect(),    StateFilter(EditSchedStates.ChooseDate),    F.data.startswith("CAL_DAY|"),)async def es_choose_date(query: CallbackQuery, state: FSMContext):    _, selected = query.data.split("|", 1)    await state.update_data(edit_date=selected)    # --- ÑƒĞ¶Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ° ÑÑ‚Ñƒ Ğ´Ğ°Ñ‚Ñƒ ---    current = [        name for waiter_id, name, date, hours, _ in get_all_shifts()        if date == selected    ]    if current:        assigned_block = "Ğ£Ğ¶Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ñ‹:\nâ€¢ " + "\nâ€¢ ".join(current)    else:        assigned_block = "<i>ÑĞ¼ĞµĞ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°</i>"    # --- ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ---    employees_shifts = get_employees_with_shifts()    if not employees_shifts:        await query.message.edit_text(            "ĞĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ°.",            reply_markup=InlineKeyboardMarkup(inline_keyboard=[                [InlineKeyboardButton(text="âª ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="AM_EDIT_SCHEDULE")]            ])        )        return    # Remove duplicates by waiter_id while preserving order    seen = set()    unique_waiters = [        (waiter_id, name)        for waiter_id, name, _, _, _ in employees_shifts        if not (waiter_id in seen or seen.add(waiter_id))    ]    if not unique_waiters:        await query.message.edit_text(            "ĞĞµÑ‚ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ°.",            reply_markup=InlineKeyboardMarkup(inline_keyboard=[                [InlineKeyboardButton(text="âª ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="AM_EDIT_SCHEDULE")]            ])        )        return    buttons = [        [            InlineKeyboardButton(                text=name,                callback_data=f"ES_WAITER|{waiter_id}",            )        ]        for waiter_id, name in unique_waiters    ]    kb = InlineKeyboardMarkup(inline_keyboard=buttons)    kb.inline_keyboard.append(        [InlineKeyboardButton(text="âª ĞÑ‚Ğ¼ĞµĞ½Ğ°", callback_data="AM_EDIT_SCHEDULE")]    )    await state.set_state(EditSchedStates.ChooseWaiter)    await query.message.edit_text(        f"<b>Ğ”Ğ°Ñ‚Ğ°:</b> {selected}\n\n{assigned_block}\n\n<b>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°:</b>",        parse_mode="HTML",        reply_markup=kb,    )# â”€â”€â”€â”€â”€ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ° Ğ¸Ğ· ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ â”€â”€â”€â”€â”€@admin.callback_query(    AdminProtect(),    StateFilter(EditSchedStates.ChooseDate),    F.data == "CAL_CANCEL",)async def es_cancel_edit(query: CallbackQuery, state: FSMContext):    await state.clear()    await admin_menu(query.message, state)# â”€â”€â”€â”€â”€ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ½Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data.startswith("ES_WAITER|"))async def es_select_waiter(query: CallbackQuery, state: FSMContext):    _, waiter_id = query.data.split("|", 1)    await state.update_data(waiter_id=int(waiter_id))    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(text="ğŸ“ ĞŸÑ€Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸", callback_data="ES_TASKS")],        [InlineKeyboardButton(text="âŒ Ğ‘ĞµĞ· Ğ·Ğ°Ğ´Ğ°Ñ‡",      callback_data="ES_NO_TASKS")],    ])    kb.inline_keyboard.append(        [InlineKeyboardButton(text="â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´", callback_data="AM_EDIT_SCHEDULE")]    )    date = (await state.get_data())["edit_date"]    # Fetch name for display    cur = get_cursor()    cur.execute("""        SELECT COALESCE(e.first_name || ' ' || e.last_name, w.name) AS name        FROM waiters w        LEFT JOIN employees e ON w.employee_id = e.id        WHERE w.id = ?    """, (int(waiter_id),))    name = cur.fetchone()[0] or "Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸"    await state.set_state(EditSchedStates.ChooseTaskAction)    await query.message.edit_text(        f"{date} â€” {name}",        reply_markup=kb,    )# â”€â”€â”€â”€â”€ Â«Ğ±ĞµĞ· Ğ·Ğ°Ğ´Ğ°Ñ‡Â» â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "ES_NO_TASKS")async def es_no_tasks(query: CallbackQuery, state: FSMContext):    data = await state.get_data()    waiter_id = data["waiter_id"]    add_shift(waiter_id, data["edit_date"])    await query.message.edit_text("Ğ—Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚. Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½.", reply_markup=KB_BACK_MENU)    await state.clear()@admin.message(AdminProtect(), StateFilter(EditSchedStates.InputPersonalTasks))async def es_save_tasks(message: Message, state: FSMContext):    data = await state.get_data()    waiter_id = data["waiter_id"]    add_shift(waiter_id, data["edit_date"])    set_shift_tasks(waiter_id, data["edit_date"], message.text.strip())    await message.answer("Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹.", reply_markup=KB_BACK_MENU)    await state.clear()# â”€â”€â”€â”€â”€ Ğ²Ğ²Ğ¾Ğ´ ÑĞ¿Ğ¸ÑĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡ â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "ES_TASKS")async def es_enter_tasks(query: CallbackQuery, state: FSMContext):    await state.set_state(EditSchedStates.InputPersonalTasks)    await query.message.edit_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¿ÑƒĞ½ĞºÑ‚ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸):")@admin.message(AdminProtect(), StateFilter(EditSchedStates.InputPersonalTasks))async def es_save_tasks(message: Message, state: FSMContext):    data = await state.get_data()    wid = get_waiter_by_tg(data["selected_tg"])[0]    add_shift(wid, data["edit_date"])    set_shift_tasks(wid, data["edit_date"], message.text.strip())    await message.answer("Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹.", reply_markup=KB_BACK_MENU)    await state.clear()# ----- back menu button -----@admin.callback_query(AdminProtect(), F.data == "AM_BACK_MENU")async def es_back(query: CallbackQuery, state: FSMContext):    await admin_menu(query.message, state)    await _safe_delete_message(query.bot, query.message.chat.id, query.message.message_id)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# SALARY# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_CALC_SALARY")async def calc_salary(query: CallbackQuery):    """    Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñƒ.    * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ²ĞºÑƒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ employees    * tg_id 2015462319 â†’ 180 Ñ€ÑƒĞ±/Ñ‡Ğ°Ñ (Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹)    * Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ        â†’ HOURLY_RATE (default 140) ĞµÑĞ»Ğ¸ ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°    """    default_rate = float(os.getenv("HOURLY_RATE", "140"))    vip_tg_id    = 2015462319    # ÑƒĞ·Ğ½Ğ°Ñ‘Ğ¼ Ğ¸Ğ¼Ñ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ½Ñ‚Ğ° Ñ ÑÑ‚Ğ¸Ğ¼ tg_id    vip_row = sqlite_db.get_waiter_by_tg(vip_tg_id)    vip_name = vip_row[1] if vip_row else None    total_all = 0.0    text = "<b>Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ğ·Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñ‹</b>\n\n"    # Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¼ĞµĞ½Ñ‹ Ğ¿Ğ¾ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºÑƒ, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ÑĞ¼ĞµĞ½Ñ‹ Ğ±ĞµĞ· Ñ‡Ğ°ÑĞ¾Ğ²    shifts_by_employee: dict[tuple[int, str], list[tuple[str, float]]] = {}    for emp_id, name, date, hrs, _ in get_all_shifts():        if hrs is None or hrs <= 0:  # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¼ĞµĞ½Ñ‹ Ğ±ĞµĞ· Ñ‡Ğ°ÑĞ¾Ğ²            continue        shifts_by_employee.setdefault((emp_id, name), []).append((date, hrs))    for (emp_id, name), person_shifts in shifts_by_employee.items():        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ²ĞºÑƒ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…        employee = sqlite_db.get_employee_by_id(emp_id)        rate = employee[4] if employee and employee[4] is not None else default_rate        # ĞŸĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ´Ğ»Ñ VIP-Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ        if vip_name and name == vip_name:            rate = 180        subtotal = 0.0        text += f"<u>{name or 'Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸'}</u>\n"        for date, hrs in person_shifts:            line, pay = _format_payline(date, hrs, rate)            text += line + "\n"            subtotal += pay        text += f"â¡ï¸ <b>Ğ˜Ñ‚Ğ¾Ğ³Ğ¾: {subtotal:.2f}</b>\n\n"        total_all += subtotal    text += f"<b>ĞĞ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğº Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğµ: {total_all:.2f}</b>"    today = datetime.today()    kb = InlineKeyboardMarkup(inline_keyboard=[        [InlineKeyboardButton(            text="ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ·Ğ° Ğ¼ĞµÑÑÑ†",            callback_data=f"AM_CLEAR_PAY|{today.year}|{today.month:02d}"        )],        [InlineKeyboardButton(text="âª Ğ’ Ğ¼ĞµĞ½Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°", callback_data="AM_BACK_MENU")],    ])    await query.message.edit_text(text, parse_mode="HTML", reply_markup=kb)@admin.callback_query(AdminProtect(), F.data.startswith("AM_CLEAR_PAY|"))async def clear_pay(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|", 2)    cur_local = get_cursor()    cur_local.execute("UPDATE shifts SET hours=NULL WHERE date LIKE ?", (f"{y}-{m}-%",))    sqlite_db.base.commit()    await query.answer("Ğ§Ğ°ÑÑ‹ Ğ·Ğ° Ğ¼ĞµÑÑÑ† Ğ¾Ğ±Ğ½ÑƒĞ»ĞµĞ½Ñ‹!", show_alert=True)    await admin_menu(query.message, state)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# NOTIFY & EXPORT# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_NOTIFY")async def notify(query: CallbackQuery, state: FSMContext):    # Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ FSM, ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ñ‚Ğ°Ğ¼ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ    await state.clear()    # ĞĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ²ÑĞ·Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ, Ñ‡Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¸ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ    await query.answer("ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºÑƒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹â€¦")    # ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ get_all_waiters() Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº TG-ID    for tg in get_all_waiters():        try:            await query.bot.send_message(                tg,                "â„¹ï¸ Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ±Ñ‹Ğ» Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½! ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ²ÑƒÑ ÑĞ¼ĞµĞ½Ñƒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ /menu."            )        except Exception:            # ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ğ» Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼            continue    # Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, ÑĞ¾Ğ¾Ğ±Ñ‰Ğ°Ñ Ğ¾Ğ± Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ğ¸ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸    await query.message.edit_text(        "Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ âœ…",        reply_markup=KB_BACK_MENU    )# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€# EXPORT ALL (Updated for 15 Days with Date Selection)# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€@admin.callback_query(AdminProtect(), F.data == "AM_EXPORT_ALL")async def export_all_start(query: CallbackQuery, state: FSMContext):    await state.clear()    today = datetime.today()    marked = set()  # ĞĞµ Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ Ğ´Ğ°Ñ‚Ñ‹, Ñ‚Ğ°Ğº ĞºĞ°Ğº ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ´Ğ°Ñ‚Ñ‹    kb = make_calendar(today.year, today.month, marked)    await state.set_state(ExportScheduleStates.ChooseStartDate)    await query.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ±ÑƒĞ´ĞµÑ‚ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ 15 Ğ´Ğ½ĞµĞ¹):", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(ExportScheduleStates.ChooseStartDate), F.data.startswith("CAL_DAY|"))async def export_all_choose_date(query: CallbackQuery, state: FSMContext):    _, date_str = query.data.split("|", 1)    start_date = datetime.strptime(date_str, "%Y-%m-%d")    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²    emps = [{"id": eid, "last_name": ln, "first_name": fn, "role": role}            for eid, ln, fn, role in get_all_employees()]    # Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‡Ğ°ÑĞ¾Ğ²    def get_h(eid, date): return get_work_hours(eid, date)    # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ·Ğ° 15 Ğ´Ğ½ĞµĞ¹    with tempfile.NamedTemporaryFile(delete=False, suffix=".xlsx") as tmp:        export_hours_schedule(start_date, emps, get_h, tmp.name)        await query.message.answer_document(            FSInputFile(tmp.name, filename=f"schedule_{start_date.strftime('%d%m%Y')}.xlsx"),            reply_markup=KB_BACK_MENU        )    os.remove(tmp.name)    await state.clear()@admin.callback_query(AdminProtect(), StateFilter(ExportScheduleStates.ChooseStartDate), F.data == "CAL_CANCEL")async def export_all_cancel(query: CallbackQuery, state: FSMContext):    await state.clear()    await admin_menu(query.message, state)@admin.callback_query(AdminProtect(), StateFilter(ExportScheduleStates.ChooseStartDate), F.data.startswith("CAL_PREV|"))async def export_all_prev_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) - 1    if m == 0:        y, m = y - 1, 12    kb = make_calendar(y, m, set())    await state.update_data(edit_year=y, edit_month=m)    await query.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ±ÑƒĞ´ĞµÑ‚ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ 15 Ğ´Ğ½ĞµĞ¹):", reply_markup=kb)@admin.callback_query(AdminProtect(), StateFilter(ExportScheduleStates.ChooseStartDate), F.data.startswith("CAL_NEXT|"))async def export_all_next_month(query: CallbackQuery, state: FSMContext):    _, y, m = query.data.split("|")    y, m = int(y), int(m) + 1    if m == 13:        y, m = y + 1, 1    kb = make_calendar(y, m, set())    await state.update_data(edit_year=y, edit_month=m)    await query.message.edit_text("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° (Ğ±ÑƒĞ´ĞµÑ‚ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ 15 Ğ´Ğ½ĞµĞ¹):", reply_markup=kb)